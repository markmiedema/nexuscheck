{% extends "report/base.html" %}

{% block content %}
<!-- Complete State Summary Page -->
<div class="page">
    <!-- Navy Header Bar -->
    <div class="page-header">
        <table>
            <tr>
                <td style="width: 100pt;">
                    <span class="header-logo"><span class="header-logo-a">A</span>ST</span>
                </td>
                <td>
                    <span class="header-divider"></span>
                    <span class="header-title">NEXUS ANALYSIS REPORT</span>
                    <div class="header-subtitle">Sales Tax Nexus Determination & Liability Assessment</div>
                </td>
            </tr>
        </table>
    </div>

    <div class="page-content">
        <h2>Complete State Summary</h2>
        <p class="text-muted text-small mb-1">
            Full list of all states with sales activity during the analysis period.
        </p>

        <table class="data-table">
            <thead>
                <tr>
                    <th>State</th>
                    <th class="text-center">Status</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Threshold</th>
                    <th class="text-center">% of Threshold</th>
                    <th class="text-right">Est. Liability</th>
                </tr>
            </thead>
            <tbody>
                {% for state in all_states %}
                <tr>
                    <td>
                        <span class="status-dot {% if state.nexus_status == 'has_nexus' %}red{% elif state.nexus_status == 'approaching' %}yellow{% else %}green{% endif %}"></span>
                        {{ state.state_name }}
                    </td>
                    <td class="text-center">
                        {% if state.nexus_status == 'has_nexus' %}
                        <strong style="color: #c8102e;">Nexus</strong>
                        {% elif state.nexus_status == 'approaching' %}
                        <span style="color: #d97706;">Approaching</span>
                        {% else %}
                        <span style="color: #059669;">No Nexus</span>
                        {% endif %}
                    </td>
                    <td class="text-right currency">${{ "{:,.0f}".format(state.total_sales) }}</td>
                    <td class="text-right currency">${{ "{:,.0f}".format(state.threshold) }}</td>
                    <td class="text-center">{{ state.threshold_percent | round(0) | int }}%</td>
                    <td class="text-right currency font-bold">
                        {% if state.estimated_liability > 0 %}
                        ${{ "{:,.0f}".format(state.estimated_liability) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <table class="data-cards-table mt-2">
            <tr>
                <td>
                    <div class="data-card-title">DATA PERIOD SUMMARY</div>
                    <table class="data-row-table">
                        <tr>
                            <td class="label">Analysis Period</td>
                            <td class="value">
                                {% if period_start and period_end %}
                                {{ period_start }} - {{ period_end }}
                                {% else %}
                                As of {{ report_date }}
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td class="label">Total Transactions Analyzed</td>
                            <td class="value">{{ "{:,}".format(total_transactions) }}</td>
                        </tr>
                        <tr>
                            <td class="label">States with Activity</td>
                            <td class="value">{{ states_with_activity }}</td>
                        </tr>
                        <tr>
                            <td class="label">Report Generated</td>
                            <td class="value">{{ report_date }}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
    </div>

    <!-- Red Footer Bar -->
    <div class="page-footer">
        <table>
            <tr>
                <td>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</td>
                <td style="text-align: right;"><span class="page-number">PAGE</span></td>
            </tr>
        </table>
    </div>
</div>

<!-- Methodology Page -->
<div class="page">
    <!-- Navy Header Bar -->
    <div class="page-header">
        <table>
            <tr>
                <td style="width: 100pt;">
                    <span class="header-logo"><span class="header-logo-a">A</span>ST</span>
                </td>
                <td>
                    <span class="header-divider"></span>
                    <span class="header-title">NEXUS ANALYSIS REPORT</span>
                    <div class="header-subtitle">Sales Tax Nexus Determination & Liability Assessment</div>
                </td>
            </tr>
        </table>
    </div>

    <div class="page-content">
        <h2>Methodology</h2>

        <div class="methodology-section">
            <h4>Nexus Determination</h4>
            <p>
                Economic nexus is determined by analyzing sales volume and transaction count against
                each state's established thresholds. Following the South Dakota v. Wayfair decision (2018),
                most states have adopted economic nexus standards, typically requiring sellers to collect
                and remit sales tax once they exceed $100,000 in sales or 200 transactions within the state.
            </p>
        </div>

        <div class="methodology-section">
            <h4>Liability Estimation</h4>
            <p>
                Tax liability estimates are calculated using state and local tax rates applied to taxable
                sales. Interest is computed from the estimated nexus date using each state's statutory
                interest rate. Penalties are estimated based on typical late filing and payment penalty
                structures, which vary by state.
            </p>
        </div>

        <div class="methodology-section">
            <h4>VDA Savings Calculation</h4>
            <p>
                Voluntary Disclosure Agreement (VDA) savings represent the potential reduction in penalties
                and interest that may be available through state VDA programs. Most states offer penalty
                abatement and limited lookback periods for sellers who proactively come forward to register
                and remit back taxes.
            </p>
        </div>

        <div class="methodology-section">
            <h4>Filing Frequency</h4>
            <p>
                Filing frequency recommendations are based on each state's filing requirements, which are
                typically determined by annual tax liability. Common frequencies include monthly, quarterly,
                and annual filing. Higher liability generally corresponds to more frequent filing requirements.
            </p>
        </div>

        <h2 class="mt-2">Disclaimers</h2>

        <div class="disclaimer-box">
            <h4>Important Notice</h4>
            <p>
                This report is provided for informational purposes only and does not constitute legal,
                tax, or professional advice. The analysis is based on the transaction data provided and
                current state nexus laws as of the report date. Tax laws and thresholds are subject to
                change, and actual liability may differ from estimates presented herein.
            </p>
            <p class="mt-1">
                Liability estimates are approximations based on available data and standard tax rates.
                Actual tax liability may vary based on product taxability, customer exemptions, and
                jurisdiction-specific rules. We recommend consulting with a qualified tax professional
                before making registration or filing decisions based on this analysis.
            </p>
        </div>

        {% if preparer_name or preparer_firm %}
        <table class="data-cards-table mt-2">
            <tr>
                <td>
                    <div class="data-card-title">REPORT PREPARED BY</div>
                    <table class="data-row-table">
                        {% if preparer_name %}
                        <tr>
                            <td class="label">Preparer</td>
                            <td class="value">{{ preparer_name }}</td>
                        </tr>
                        {% endif %}
                        {% if preparer_firm %}
                        <tr>
                            <td class="label">Firm</td>
                            <td class="value">{{ preparer_firm }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td class="label">Date</td>
                            <td class="value">{{ report_date }}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
        {% endif %}
    </div>

    <!-- Red Footer Bar -->
    <div class="page-footer">
        <table>
            <tr>
                <td>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</td>
                <td style="text-align: right;"><span class="page-number">PAGE</span></td>
            </tr>
        </table>
    </div>
</div>
{% endblock %}
