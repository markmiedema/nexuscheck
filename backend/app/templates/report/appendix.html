{% extends "report/base.html" %}

{% block content %}
<!-- Complete State Summary Page -->
<div class="page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-left">
            {% if logo_data_uri %}
            <img src="{{ logo_data_uri }}" alt="Logo" class="page-header-logo" />
            {% endif %}
            <div class="page-header-title">
                <h1>NEXUS ANALYSIS REPORT</h1>
                <div class="subtitle">Sales Tax Nexus Determination & Liability Assessment</div>
            </div>
        </div>
    </div>

    <div class="page-content">
        <h2>Complete State Summary</h2>
        <p class="text-muted text-small mb-1">
            Full list of all states with sales activity during the analysis period.
        </p>

        <table class="summary-table">
            <thead>
                <tr>
                    <th>State</th>
                    <th class="text-center">Status</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Threshold</th>
                    <th class="text-center">% of Threshold</th>
                    <th class="text-right">Est. Liability</th>
                </tr>
            </thead>
            <tbody>
                {% for state in all_states %}
                <tr>
                    <td>
                        <span class="status-dot {% if state.nexus_status == 'has_nexus' %}red{% elif state.nexus_status == 'approaching' %}yellow{% else %}green{% endif %}"></span>
                        {{ state.state_name }}
                    </td>
                    <td class="text-center">
                        {% if state.nexus_status == 'has_nexus' %}
                        <strong style="color: #c8102e;">Nexus</strong>
                        {% elif state.nexus_status == 'approaching' %}
                        <span style="color: #d97706;">Approaching</span>
                        {% else %}
                        <span style="color: #059669;">No Nexus</span>
                        {% endif %}
                    </td>
                    <td class="text-right currency">${{ "{:,.0f}".format(state.total_sales) }}</td>
                    <td class="text-right currency">${{ "{:,.0f}".format(state.threshold) }}</td>
                    <td class="text-center">{{ state.threshold_percent | round(0) | int }}%</td>
                    <td class="text-right currency font-bold">
                        {% if state.estimated_liability > 0 %}
                        ${{ "{:,.0f}".format(state.estimated_liability) }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="data-card mt-2">
            <h4>Data Period Summary</h4>
            <div class="data-row">
                <span class="data-label">Analysis Period</span>
                <span class="data-value">
                    {% if period_start and period_end %}
                    {{ period_start }} - {{ period_end }}
                    {% else %}
                    As of {{ report_date }}
                    {% endif %}
                </span>
            </div>
            <div class="data-row">
                <span class="data-label">Total Transactions Analyzed</span>
                <span class="data-value">{{ "{:,}".format(total_transactions) }}</span>
            </div>
            <div class="data-row">
                <span class="data-label">States with Activity</span>
                <span class="data-value">{{ states_with_activity }}</span>
            </div>
            <div class="data-row">
                <span class="data-label">Report Generated</span>
                <span class="data-value">{{ report_date }}</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="page-footer">
        <span>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</span>
        <span class="page-number">PAGE</span>
    </div>
</div>

<!-- Methodology Page -->
<div class="page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-left">
            {% if logo_data_uri %}
            <img src="{{ logo_data_uri }}" alt="Logo" class="page-header-logo" />
            {% endif %}
            <div class="page-header-title">
                <h1>NEXUS ANALYSIS REPORT</h1>
                <div class="subtitle">Sales Tax Nexus Determination & Liability Assessment</div>
            </div>
        </div>
    </div>

    <div class="page-content">
        <h2>Methodology</h2>

        <div class="methodology-section">
            <h4>Nexus Determination</h4>
            <p>
                Economic nexus is determined based on each state's revenue and/or transaction thresholds.
                Physical nexus is determined based on reported physical presence (employees, property, etc.)
                in each state. Once nexus is established, it typically remains in effect until the business
                formally withdraws from the state.
            </p>
        </div>

        <div class="methodology-section">
            <h4>Liability Estimation</h4>
            <p>
                Estimated tax liability is calculated using each state's combined state and average local tax rates
                applied to taxable sales. Interest is calculated from the estimated nexus date using state-specific
                rates and compounding methods. Penalties are calculated based on each state's late filing and
                late payment penalty structures.
            </p>
        </div>

        <div class="methodology-section">
            <h4>VDA Savings Calculation</h4>
            <p>
                VDA (Voluntary Disclosure Agreement) savings are estimated based on typical penalty waivers
                offered by each state. Most states waive penalties entirely through VDA programs; some also
                offer reduced or waived interest. The savings shown represent the estimated penalty amounts
                that would be waived through a VDA.
            </p>
        </div>

        <div class="methodology-section">
            <h4>Filing Frequency</h4>
            <p>
                Recommended filing frequency is based on typical state requirements for sellers with similar
                sales volumes. Actual requirements may vary based on state-specific rules and thresholds.
                Monthly filing is typically required for high-volume sellers ($1M+ annual taxable sales),
                quarterly for mid-volume ($100K-$1M), and annual for lower-volume sellers.
            </p>
        </div>

        <div class="section-divider"></div>

        <h2>Disclaimers</h2>

        <div class="disclaimer-box">
            <h4>Important Notice</h4>
            <p>
                This report is provided for informational purposes only and does not constitute tax, legal,
                or accounting advice. The information contained herein is based on the sales data provided
                and publicly available information regarding state tax laws and regulations.
            </p>
            <p class="mt-1">
                Economic nexus thresholds and tax rates are subject to change. Users should verify current
                requirements with each state's Department of Revenue or consult with a qualified tax professional
                before making compliance decisions.
            </p>
            <p class="mt-1">
                Estimated liabilities are approximations based on available data and may differ from actual
                amounts due to various factors including exemptions, credits, rate variations, and local
                jurisdiction requirements.
            </p>
        </div>

        {% if preparer_name or preparer_firm %}
        <div class="data-card mt-2">
            <h4>Report Prepared By</h4>
            <div class="data-row">
                {% if preparer_name %}
                <span class="data-label">Preparer</span>
                <span class="data-value">{{ preparer_name }}</span>
                {% endif %}
            </div>
            {% if preparer_firm %}
            <div class="data-row">
                <span class="data-label">Firm</span>
                <span class="data-value">{{ preparer_firm }}</span>
            </div>
            {% endif %}
            <div class="data-row">
                <span class="data-label">Date</span>
                <span class="data-value">{{ report_date }}</span>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Footer -->
    <div class="page-footer">
        <span>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</span>
        <span class="page-number">PAGE</span>
    </div>
</div>
{% endblock %}
