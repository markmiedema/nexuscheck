{% extends "report/base.html" %}

{% block content %}
<div class="page">
    <!-- State Header -->
    <div class="state-header">
        <table>
            <tr>
                <td>
                    <span class="state-name">{{ state_name }}</span>
                    <span class="state-code">({{ state_code }})</span>
                </td>
                <td style="text-align: right;">
                    <span class="nexus-badge">
                        {% if nexus_status == 'has_nexus' %}HAS NEXUS{% elif nexus_status == 'approaching' %}APPROACHING{% else %}NO NEXUS{% endif %}
                    </span>
                </td>
            </tr>
        </table>
    </div>

    <div class="page-content">
        <!-- Data Cards using table -->
        <table class="data-cards-table">
            <tr>
                <td>
                    <div class="data-card-title">SALES SUMMARY</div>
                    <table class="data-row-table">
                        <tr>
                            <td class="label">Total Sales</td>
                            <td class="value currency">${{ "{:,.0f}".format(total_sales) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Direct Sales</td>
                            <td class="value currency">${{ "{:,.0f}".format(direct_sales) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Marketplace Sales</td>
                            <td class="value currency">${{ "{:,.0f}".format(marketplace_sales) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Taxable Sales</td>
                            <td class="value highlight currency">${{ "{:,.0f}".format(taxable_sales) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Exempt Sales</td>
                            <td class="value currency">${{ "{:,.0f}".format(exempt_sales) }}</td>
                        </tr>
                    </table>
                </td>
                <td>
                    <div class="data-card-title">LIABILITY PREDICTIONS</div>
                    <table class="data-row-table">
                        <tr>
                            <td class="label">Base Tax</td>
                            <td class="value currency">${{ "{:,.2f}".format(base_tax) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Interest</td>
                            <td class="value currency">${{ "{:,.2f}".format(interest) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Penalties</td>
                            <td class="value currency">${{ "{:,.2f}".format(penalties) }}</td>
                        </tr>
                        <tr style="border-top: 2px solid #dee2e6;">
                            <td class="label"><strong>Est. Liability</strong></td>
                            <td class="value highlight currency"><strong>${{ "{:,.2f}".format(estimated_liability) }}</strong></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>

        <!-- VDA Savings Box -->
        {% if vda_savings and vda_savings > 0 %}
        <div class="vda-box">
            <div class="vda-title">Voluntary Disclosure Agreement Opportunity</div>
            <table style="width: 100%;">
                <tr>
                    <td style="width: 60%;">
                        <table class="data-row-table">
                            <tr>
                                <td class="label">Liability Without VDA</td>
                                <td class="value currency">${{ "{:,.2f}".format(before_vda) }}</td>
                            </tr>
                            <tr>
                                <td class="label">Liability With VDA</td>
                                <td class="value currency">${{ "{:,.2f}".format(with_vda) }}</td>
                            </tr>
                        </table>
                    </td>
                    <td style="text-align: center;">
                        <div class="text-small text-muted">Potential Savings</div>
                        <div class="vda-amount">${{ "{:,.0f}".format(vda_savings) }}</div>
                    </td>
                </tr>
            </table>
        </div>
        {% endif %}

        <!-- Second Row of Data Cards -->
        <table class="data-cards-table">
            <tr>
                <td>
                    <div class="data-card-title">THRESHOLD REQUIREMENTS</div>
                    <table class="data-row-table">
                        <tr>
                            <td class="label">Revenue Threshold</td>
                            <td class="value currency">${{ "{:,.0f}".format(threshold) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Current Progress</td>
                            <td class="value">{{ "{:.1f}%".format(threshold_percent) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Transaction Threshold</td>
                            <td class="value">200 transactions</td>
                        </tr>
                    </table>
                </td>
                <td>
                    <div class="data-card-title">TAX RATES & FILING</div>
                    <table class="data-row-table">
                        <tr>
                            <td class="label">State Rate</td>
                            <td class="value">{{ "{:.3f}%".format(state_rate) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Avg. Local Rate</td>
                            <td class="value">{{ "{:.3f}%".format(avg_local_rate) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Combined Rate</td>
                            <td class="value highlight">{{ "{:.3f}%".format(combined_rate) }}</td>
                        </tr>
                        <tr>
                            <td class="label">Filing Frequency</td>
                            <td class="value">{{ filing_frequency | default('Monthly') }}</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>

        <!-- Year-by-Year Breakdown -->
        {% if year_data and year_data | length > 0 %}
        <h3 class="mt-2">Year-by-Year Breakdown</h3>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Year</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Taxable Sales</th>
                    <th class="text-right">Base Tax</th>
                    <th class="text-right">Est. Liability</th>
                </tr>
            </thead>
            <tbody>
                {% for year in year_data %}
                <tr>
                    <td><strong>{{ year.year }}</strong></td>
                    <td class="text-right currency">${{ "{:,.0f}".format(year.total_sales) }}</td>
                    <td class="text-right currency">${{ "{:,.0f}".format(year.taxable_sales) }}</td>
                    <td class="text-right currency">${{ "{:,.2f}".format(year.base_tax) }}</td>
                    <td class="text-right currency font-bold">${{ "{:,.0f}".format(year.estimated_liability) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Red Footer Bar -->
    <div class="page-footer">
        <table>
            <tr>
                <td>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</td>
                <td style="text-align: right;"><span class="page-number">PAGE</span></td>
            </tr>
        </table>
    </div>
</div>
{% endblock %}
