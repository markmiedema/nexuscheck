{% extends "report/base.html" %}

{% block content %}
<div class="page">
    <!-- State Header with Navy-to-Red Gradient -->
    <div class="state-header">
        <div>
            <span class="state-name">{{ state_name }}</span>
            <span class="state-code">({{ state_code }})</span>
        </div>
        <div class="nexus-badge {% if nexus_status == 'approaching' %}approaching{% elif nexus_status == 'no_nexus' %}no-nexus{% endif %}">
            {% if nexus_status == 'has_nexus' %}HAS NEXUS{% elif nexus_status == 'approaching' %}APPROACHING{% else %}NO NEXUS{% endif %}
        </div>
    </div>

    <div class="page-content" style="padding-top: 0.4in;">
        <!-- Threshold Progress Bar (for approaching states) -->
        {% if nexus_status == 'approaching' %}
        <div class="progress-container mb-2">
            <div class="data-row" style="margin-bottom: 0.1in;">
                <span class="data-label">Progress to Nexus Threshold</span>
                <span class="data-value">{{ threshold_percent | round(0) | int }}%</span>
            </div>
            <div class="progress-bar" style="height: 14px;">
                <div class="progress-fill warning" style="width: {{ [threshold_percent, 100] | min }}%;"></div>
            </div>
            <div class="progress-labels">
                <span>Current: ${{ "{:,.0f}".format(total_sales) }}</span>
                <span>Threshold: ${{ "{:,.0f}".format(threshold) }}</span>
            </div>
            {% if amount_until_nexus > 0 %}
            <p class="text-small text-muted text-center mt-1">
                ${{ "{:,.0f}".format(amount_until_nexus) }} remaining until nexus threshold
            </p>
            {% endif %}
        </div>
        {% endif %}

        <div class="data-grid">
            <!-- Sales Summary -->
            <div class="data-card">
                <h4>Sales Summary</h4>
                <div class="data-row">
                    <span class="data-label">Total Sales</span>
                    <span class="data-value currency">${{ "{:,.0f}".format(total_sales) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Direct Sales</span>
                    <span class="data-value currency">${{ "{:,.0f}".format(direct_sales) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Marketplace Sales</span>
                    <span class="data-value currency">${{ "{:,.0f}".format(marketplace_sales) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Taxable Sales</span>
                    <span class="data-value highlight currency">${{ "{:,.0f}".format(taxable_sales) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Exempt Sales</span>
                    <span class="data-value currency">${{ "{:,.0f}".format(exempt_sales) }}</span>
                </div>
            </div>

            <!-- Liability Breakdown -->
            <div class="data-card">
                <h4>Liability Predictions</h4>
                <div class="data-row">
                    <span class="data-label">Base Tax</span>
                    <span class="data-value currency">${{ "{:,.2f}".format(base_tax) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Interest</span>
                    <span class="data-value currency">${{ "{:,.2f}".format(interest) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Penalties</span>
                    <span class="data-value currency">${{ "{:,.2f}".format(penalties) }}</span>
                </div>
                <div class="data-row" style="border-top: 2px solid #dee2e6; margin-top: 0.1in; padding-top: 0.1in;">
                    <span class="data-label"><strong>Est. Remittance</strong></span>
                    <span class="data-value highlight currency"><strong>${{ "{:,.2f}".format(estimated_liability) }}</strong></span>
                </div>
            </div>
        </div>

        <!-- VDA Savings Box -->
        {% if vda_savings and vda_savings > 0 %}
        <div class="vda-box">
            <div class="vda-title">Voluntary Disclosure Agreement Opportunity</div>
            <div class="data-grid" style="margin: 0.1in 0 0 0; gap: 0.5in;">
                <div>
                    <div class="data-row">
                        <span class="data-label">Liability Without VDA</span>
                        <span class="data-value currency">${{ "{:,.2f}".format(before_vda) }}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Liability With VDA</span>
                        <span class="data-value currency">${{ "{:,.2f}".format(with_vda) }}</span>
                    </div>
                </div>
                <div style="text-align: center;">
                    <div class="text-small text-muted">Potential Savings</div>
                    <div class="vda-amount">${{ "{:,.0f}".format(vda_savings) }}</div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="data-grid">
            <!-- Threshold Requirements -->
            <div class="data-card">
                <h4>Visibility Respective Constituent</h4>
                <div class="data-row">
                    <span class="data-label">Revenue Threshold</span>
                    <span class="data-value currency">${{ "{:,.0f}".format(threshold) }}</span>
                </div>
                {% if transaction_threshold %}
                <div class="data-row">
                    <span class="data-label">Transaction Threshold</span>
                    <span class="data-value">{{ "{:,}".format(transaction_threshold) }}</span>
                </div>
                {% endif %}
                <div class="data-row">
                    <span class="data-label">Threshold Percent</span>
                    <span class="data-value">{{ "{:.1f}%".format(threshold_percent) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Nexus Type</span>
                    <span class="data-value">{{ nexus_type | title if nexus_type else 'N/A' }}</span>
                </div>
            </div>

            <!-- Tax Rates & Filing -->
            <div class="data-card">
                <h4>Tax Rates & Filing</h4>
                <div class="data-row">
                    <span class="data-label">State Rate</span>
                    <span class="data-value">{{ "{:.3f}%".format(state_rate) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Avg. Local C-STC</span>
                    <span class="data-value">{{ "{:.3f}%".format(avg_local_rate) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Combined Rate</span>
                    <span class="data-value highlight">{{ "{:.3f}%".format(combined_rate) }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Filing Frequency</span>
                    <span class="data-value">{{ filing_frequency | default('Monthly') }}</span>
                </div>
            </div>
        </div>

        <!-- Year-by-Year Breakdown -->
        {% if year_data and year_data | length > 0 %}
        <h3 class="mt-2">Year-by-Year Breakdown</h3>
        <table>
            <thead>
                <tr>
                    <th>Year</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Tax Rate</th>
                    <th class="text-right">Base Tax</th>
                    <th class="text-right">Int. Yield</th>
                    <th class="text-right">Pen Value</th>
                    <th class="text-right">Total Rev.</th>
                </tr>
            </thead>
            <tbody>
                {% for year in year_data %}
                <tr>
                    <td><strong>{{ year.year }}</strong></td>
                    <td class="text-right currency">${{ "{:,.0f}".format(year.total_sales) }}</td>
                    <td class="text-right">{{ "{:.2f}%".format(combined_rate) }}</td>
                    <td class="text-right currency">${{ "{:,.2f}".format(year.base_tax) }}</td>
                    <td class="text-right currency">${{ "{:,.2f}".format(year.interest | default(0)) }}</td>
                    <td class="text-right currency">${{ "{:,.2f}".format(year.penalties | default(0)) }}</td>
                    <td class="text-right currency font-bold">${{ "{:,.2f}".format(year.estimated_liability) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>

    <!-- Footer -->
    <div class="page-footer">
        <span>PREPARED BY: AST | Advisory & Compliance | www.NexusCheck.com</span>
        <span class="page-number">PAGE</span>
    </div>
</div>
{% endblock %}
