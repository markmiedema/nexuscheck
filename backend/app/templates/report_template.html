<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Analysis Report - {{ company_name }}</title>
    <style>
        @page {
            size: letter;
            margin: 0.75in;
            @top-right {
                content: "Page " counter(page) " of " counter(pages);
                font-size: 10px;
                color: #666;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 11px;
            line-height: 1.5;
            color: #1a1a1a;
            margin: 0;
            padding: 0;
        }

        .header {
            border-bottom: 3px solid #2563eb;
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a8a;
            margin: 0 0 8px 0;
        }

        .header .subtitle {
            font-size: 14px;
            color: #64748b;
        }

        .header .meta {
            margin-top: 12px;
            display: flex;
            gap: 24px;
            font-size: 11px;
            color: #475569;
        }

        .header .meta span {
            display: inline-block;
        }

        .section {
            margin-bottom: 24px;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a8a;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
        }

        .summary-card .label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .summary-card .value {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a8a;
        }

        .summary-card .value.alert {
            color: #dc2626;
        }

        .summary-card .value.success {
            color: #16a34a;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }

        th {
            background: #f1f5f9;
            font-weight: 600;
            text-align: left;
            padding: 8px 10px;
            border-bottom: 2px solid #cbd5e1;
            color: #475569;
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:nth-child(even) {
            background: #f8fafc;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        .nexus-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .nexus-badge.has-nexus {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .nexus-badge.approaching {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .nexus-badge.no-nexus {
            background: #f0fdf4;
            color: #16a34a;
            border: 1px solid #bbf7d0;
        }

        .nexus-type {
            font-size: 9px;
            color: #64748b;
        }

        .liability-cell {
            font-weight: 600;
            color: #dc2626;
        }

        .threshold-bar {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .threshold-fill {
            height: 100%;
            border-radius: 3px;
        }

        .threshold-fill.low { background: #22c55e; }
        .threshold-fill.medium { background: #eab308; }
        .threshold-fill.high { background: #ef4444; }

        .threshold-text {
            font-size: 9px;
            color: #64748b;
            margin-top: 2px;
        }

        .state-detail {
            page-break-before: always;
            margin-top: 0;
        }

        .state-detail:first-of-type {
            page-break-before: avoid;
        }

        .state-header {
            background: #f1f5f9;
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .state-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e3a8a;
        }

        .state-status {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
        }

        .detail-card .title {
            font-size: 9px;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 4px;
        }

        .detail-card .value {
            font-size: 14px;
            font-weight: 600;
            color: #1e3a8a;
        }

        .footer {
            margin-top: 40px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
            font-size: 9px;
            color: #94a3b8;
        }

        .footer .disclaimer {
            font-style: italic;
            margin-bottom: 8px;
        }

        .footer .generated {
            text-align: right;
        }

        .page-break {
            page-break-before: always;
        }

        .no-break {
            page-break-inside: avoid;
        }

        .year-section {
            margin-bottom: 16px;
            padding: 12px;
            background: #fafafa;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }

        .year-title {
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .mini-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }

        .mini-card {
            text-align: center;
        }

        .mini-card .label {
            font-size: 8px;
            text-transform: uppercase;
            color: #6b7280;
        }

        .mini-card .value {
            font-size: 11px;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Sales Tax Nexus Analysis Report</h1>
        <div class="subtitle">{{ company_name }}</div>
        <div class="meta">
            {% if period_start and period_end %}
            <span><strong>Analysis Period:</strong> {{ period_start }} to {{ period_end }}</span>
            {% endif %}
            <span><strong>Generated:</strong> {{ generated_date }}</span>
            <span><strong>Report ID:</strong> {{ analysis_id[:8] }}...</span>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="section">
        <div class="section-title">Executive Summary</div>
        <div class="summary-grid">
            <div class="summary-card">
                <div class="label">States Analyzed</div>
                <div class="value">{{ summary.total_states_analyzed }}</div>
            </div>
            <div class="summary-card">
                <div class="label">States with Nexus</div>
                <div class="value alert">{{ summary.states_with_nexus }}</div>
            </div>
            <div class="summary-card">
                <div class="label">Approaching Threshold</div>
                <div class="value" style="color: #d97706;">{{ summary.states_approaching_threshold }}</div>
            </div>
            <div class="summary-card">
                <div class="label">Total Estimated Liability</div>
                <div class="value alert">${{ "{:,.2f}".format(summary.total_estimated_liability or 0) }}</div>
            </div>
        </div>

        <!-- Nexus Breakdown -->
        <table style="width: auto; margin-bottom: 16px;">
            <tr>
                <td style="padding-right: 24px;"><strong>Physical Nexus:</strong> {{ nexus_breakdown.physical_nexus }} states</td>
                <td style="padding-right: 24px;"><strong>Economic Nexus:</strong> {{ nexus_breakdown.economic_nexus }} states</td>
                <td><strong>Both Types:</strong> {{ nexus_breakdown.both }} states</td>
            </tr>
        </table>
    </div>

    <!-- States with Nexus -->
    {% if states_with_nexus %}
    <div class="section">
        <div class="section-title">States Requiring Immediate Action ({{ states_with_nexus|length }})</div>
        <table>
            <thead>
                <tr>
                    <th>State</th>
                    <th>Nexus Type</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Taxable Sales</th>
                    <th class="text-right">Threshold %</th>
                    <th class="text-right">Est. Liability</th>
                </tr>
            </thead>
            <tbody>
                {% for state in states_with_nexus %}
                <tr>
                    <td>
                        <strong>{{ state.state_name }}</strong>
                        <span class="nexus-badge has-nexus">Nexus</span>
                    </td>
                    <td>
                        <span class="nexus-type">
                            {% if state.nexus_type == 'physical' %}Physical{% elif state.nexus_type == 'economic' %}Economic{% elif state.nexus_type == 'both' %}Physical + Economic{% else %}{{ state.nexus_type }}{% endif %}
                        </span>
                    </td>
                    <td class="text-right">${{ "{:,.2f}".format(state.total_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.taxable_sales) }}</td>
                    <td class="text-right">
                        <div class="threshold-bar">
                            <div class="threshold-fill high" style="width: {{ [state.threshold_percent, 100]|min }}%;"></div>
                        </div>
                        <div class="threshold-text">{{ "{:.1f}".format(state.threshold_percent) }}%</div>
                    </td>
                    <td class="text-right liability-cell">${{ "{:,.2f}".format(state.estimated_liability) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- States Approaching Threshold -->
    {% if states_approaching %}
    <div class="section">
        <div class="section-title">States Approaching Threshold ({{ states_approaching|length }})</div>
        <table>
            <thead>
                <tr>
                    <th>State</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Threshold</th>
                    <th class="text-right">% of Threshold</th>
                    <th class="text-right">Amount Until Nexus</th>
                </tr>
            </thead>
            <tbody>
                {% for state in states_approaching %}
                <tr>
                    <td>
                        <strong>{{ state.state_name }}</strong>
                        <span class="nexus-badge approaching">Approaching</span>
                    </td>
                    <td class="text-right">${{ "{:,.2f}".format(state.total_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.threshold) }}</td>
                    <td class="text-right">
                        <div class="threshold-bar">
                            <div class="threshold-fill medium" style="width: {{ state.threshold_percent }}%;"></div>
                        </div>
                        <div class="threshold-text">{{ "{:.1f}".format(state.threshold_percent) }}%</div>
                    </td>
                    <td class="text-right">${{ "{:,.2f}".format(state.threshold - state.total_sales) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- All States Summary -->
    {% if include_all_states and all_states %}
    <div class="section page-break">
        <div class="section-title">Complete State Analysis ({{ all_states|length }} states)</div>
        <table>
            <thead>
                <tr>
                    <th>State</th>
                    <th>Status</th>
                    <th class="text-right">Total Sales</th>
                    <th class="text-right">Direct Sales</th>
                    <th class="text-right">Marketplace</th>
                    <th class="text-right">Taxable</th>
                    <th class="text-right">Exempt</th>
                    <th class="text-right">Liability</th>
                </tr>
            </thead>
            <tbody>
                {% for state in all_states %}
                <tr>
                    <td><strong>{{ state.state_name }}</strong></td>
                    <td>
                        {% if state.nexus_status == 'has_nexus' %}
                        <span class="nexus-badge has-nexus">Nexus</span>
                        {% elif state.nexus_status == 'approaching' %}
                        <span class="nexus-badge approaching">Approaching</span>
                        {% else %}
                        <span class="nexus-badge no-nexus">No Nexus</span>
                        {% endif %}
                    </td>
                    <td class="text-right">${{ "{:,.2f}".format(state.total_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.direct_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.marketplace_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.taxable_sales) }}</td>
                    <td class="text-right">${{ "{:,.2f}".format(state.exempt_sales) }}</td>
                    <td class="text-right {% if state.estimated_liability > 0 %}liability-cell{% endif %}">
                        {% if state.estimated_liability > 0 %}${{ "{:,.2f}".format(state.estimated_liability) }}{% else %}-{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Detailed State Analysis -->
    {% if include_state_details and state_details %}
    {% for detail in state_details %}
    <div class="section state-detail page-break no-break">
        <div class="state-header">
            <div class="state-name">{{ detail.state_name }} ({{ detail.state_code }})</div>
            <div class="state-status">
                {% if detail.nexus_status == 'has_nexus' %}
                <span class="nexus-badge has-nexus">Nexus Established</span>
                {% elif detail.nexus_status == 'approaching' %}
                <span class="nexus-badge approaching">Approaching Threshold</span>
                {% else %}
                <span class="nexus-badge no-nexus">No Nexus</span>
                {% endif %}
                {% if detail.nexus_type and detail.nexus_type != 'none' %}
                <span class="nexus-type">({{ detail.nexus_type|title }})</span>
                {% endif %}
            </div>
        </div>

        <div class="detail-grid">
            <div class="detail-card">
                <div class="title">Total Sales</div>
                <div class="value">${{ "{:,.2f}".format(detail.total_sales) }}</div>
            </div>
            <div class="detail-card">
                <div class="title">Taxable Sales</div>
                <div class="value">${{ "{:,.2f}".format(detail.taxable_sales) }}</div>
            </div>
            <div class="detail-card">
                <div class="title">Estimated Liability</div>
                <div class="value" style="color: #dc2626;">${{ "{:,.2f}".format(detail.estimated_liability) }}</div>
            </div>
        </div>

        <!-- Liability Breakdown -->
        {% if detail.estimated_liability > 0 %}
        <table style="width: auto; margin-bottom: 16px;">
            <tr>
                <td style="padding-right: 20px;"><strong>Base Tax:</strong> ${{ "{:,.2f}".format(detail.base_tax or 0) }}</td>
                <td style="padding-right: 20px;"><strong>Interest:</strong> ${{ "{:,.2f}".format(detail.interest or 0) }}</td>
                <td><strong>Penalties:</strong> ${{ "{:,.2f}".format(detail.penalties or 0) }}</td>
            </tr>
        </table>
        {% endif %}

        <!-- Year-by-Year Breakdown -->
        {% if detail.year_data %}
        {% for year in detail.year_data %}
        <div class="year-section">
            <div class="year-title">{{ year.year }}</div>
            <div class="mini-grid">
                <div class="mini-card">
                    <div class="label">Total Sales</div>
                    <div class="value">${{ "{:,.0f}".format(year.total_sales) }}</div>
                </div>
                <div class="mini-card">
                    <div class="label">Transactions</div>
                    <div class="value">{{ year.transaction_count or 0 }}</div>
                </div>
                <div class="mini-card">
                    <div class="label">Taxable</div>
                    <div class="value">${{ "{:,.0f}".format(year.taxable_sales) }}</div>
                </div>
                <div class="mini-card">
                    <div class="label">Liability</div>
                    <div class="value" style="color: #dc2626;">${{ "{:,.0f}".format(year.estimated_liability) }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}

        <!-- Compliance Information -->
        {% if detail.compliance_info %}
        <div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 6px;">
            <div style="font-weight: 600; font-size: 10px; color: #0369a1; margin-bottom: 6px;">Compliance Information</div>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 9px;">
                <div><strong>Combined Tax Rate:</strong> {{ "{:.2f}".format(detail.compliance_info.tax_rates.combined_rate) }}%</div>
                <div><strong>Filing Frequency:</strong> {{ detail.compliance_info.filing_frequency|title }}</div>
                <div><strong>Revenue Threshold:</strong> ${{ "{:,.0f}".format(detail.compliance_info.threshold_info.revenue_threshold or 0) }}</div>
                <div><strong>SSTM Member:</strong> {{ "Yes" if detail.compliance_info.sstm_member else "No" }}</div>
            </div>
            {% if detail.compliance_info.registration_info.registration_url %}
            <div style="margin-top: 6px; font-size: 9px;">
                <strong>Registration URL:</strong> {{ detail.compliance_info.registration_info.registration_url }}
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Footer -->
    <div class="footer">
        <div class="disclaimer">
            <strong>Disclaimer:</strong> This report is for informational purposes only and does not constitute tax, legal, or accounting advice.
            The liability estimates are based on available data and standard calculation methods. Actual tax obligations may vary based on
            specific circumstances, exemptions, and state regulations. Consult with a qualified tax professional before making compliance decisions.
        </div>
        <div class="generated">
            Generated by NexusCheck on {{ generated_date }} | Report ID: {{ analysis_id }}
        </div>
    </div>
</body>
</html>
